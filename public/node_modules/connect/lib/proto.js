var http=require("http"),utils=require("./utils"),debug=require("debug")("connect:dispatcher"),app=module.exports={},env=process.env.NODE_ENV||"development";app.use=function(e,t){if("string"!=typeof e&&(t=e,e="/"),"function"==typeof t.handle){var n=t;t.route=e,t=function(e,t,r){n.handle(e,t,r)}}return t instanceof http.Server&&(t=t.listeners("request")[0]),"/"==e[e.length-1]&&(e=e.slice(0,-1)),debug("use %s %s",e||"/",t.name||"anonymous"),this.stack.push({route:e,handle:t}),this},app.handle=function(e,t,n){function r(l){var c,f,p;if(s&&(e.url=e.url.substr(1),s=!1),e.url=a+e.url,e.originalUrl=e.originalUrl||e.url,a="",c=i[u++],c&&!t.headerSent)try{if(f=utils.parseUrl(e).pathname,void 0==f&&(f="/"),0!=f.toLowerCase().indexOf(c.route.toLowerCase()))return r(l);if(p=f[c.route.length],p&&"/"!=p&&"."!=p)return r(l);a=c.route,e.url=e.url.substr(a.length),o||"/"==e.url[0]||(e.url="/"+e.url,s=!0),debug("%s",c.handle.name||"anonymous");var d=c.handle.length;l?4===d?c.handle(l,e,t,r):r(l):4>d?c.handle(e,t,r):r()}catch(h){r(h)}else{if(n)return n(l);if(l){t.statusCode<400&&(t.statusCode=500),debug("default %s",t.statusCode),l.status&&(t.statusCode=l.status);var m="production"==env?http.STATUS_CODES[t.statusCode]:l.stack||l.toString();if("test"!=env&&console.error(l.stack||l.toString()),t.headerSent)return e.socket.destroy();if(t.setHeader("Content-Type","text/plain"),t.setHeader("Content-Length",Buffer.byteLength(m)),"HEAD"==e.method)return t.end();t.end(m)}else{if(debug("default 404"),t.statusCode=404,t.setHeader("Content-Type","text/plain"),"HEAD"==e.method)return t.end();t.end("Cannot "+e.method+" "+utils.escape(e.originalUrl))}}}var i=this.stack,o=~e.url.indexOf("://"),a="",s=!1,u=0;r()},app.listen=function(){var e=http.createServer(this);return e.listen.apply(e,arguments)};