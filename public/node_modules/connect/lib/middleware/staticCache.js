function respondFromCache(e,t,n){function r(){for(;s.length;)if(!1===t.write(s.shift()))return t.once("drain",r),void 0;t.end()}var i=n[0],o=utils.merge({},n[1]),s=n.slice(2);switch(o.age=(new Date-new Date(o.date))/1e3||0,e.method){case"HEAD":t.writeHead(i,o),t.end();break;case"GET":utils.conditionalGET(e)&&fresh(e.headers,o)?(o["content-length"]=0,t.writeHead(304,o),t.end()):(t.writeHead(i,o),r());break;default:t.writeHead(500,""),t.end()}}function mustRevalidate(e,t){var n=t[1],r=utils.parseCacheControl(e.headers["cache-control"]||""),i=utils.parseCacheControl(n["cache-control"]||""),o=(new Date-new Date(n.date))/1e3||0;return i["no-cache"]||i["must-revalidate"]||i["proxy-revalidate"]?!0:r["no-cache"]?!0:null!=r["max-age"]?r["max-age"]<o:null!=i["max-age"]?i["max-age"]<o:!1}function cacheKey(e){return utils.parseUrl(e).path}var utils=require("../utils"),Cache=require("../cache"),fresh=require("fresh");module.exports=function(e){var e=e||{},t=new Cache(e.maxObjects||128),n=e.maxLength||262144;return console.warn("connect.staticCache() is deprecated and will be removed in 3.0"),console.warn("use varnish or similar reverse proxy caches."),function(e,r,i){var o=cacheKey(e),s=e.headers.range,a=e.headers.cookie,u=t.get(o);e.on("static",function(e){var i,s=r._headers,u=utils.parseCacheControl(s["cache-control"]||""),c=s["content-length"];if(s["set-cookie"])return a=!0;if(!a&&!(!c||c>n||s["content-range"]||u["no-cache"]||u["no-store"]||u["private"]||u["must-revalidate"])){if(i=t.get(o)){if(s.etag==i[0].etag)return i[0].date=new Date,void 0;t.remove(o)}if(null!=e){var l=[];e.on("data",function(e){l.push(e)}),e.on("end",function(){var e=t.add(o);delete s["x-cache"],e.push(200),e.push(s),e.push.apply(e,l)})}}}),"GET"==e.method||"HEAD"==e.method?s?i():a||!u||mustRevalidate(e,u)?(r.setHeader("X-Cache","MISS"),i()):(r.setHeader("X-Cache","HIT"),respondFromCache(e,r,u)):i()}};