function compile(e){e=e.replace(/"/g,'\\"');var t='  return "'+e.replace(/:([-\w]{2,})(?:\[([^\]]+)\])?/g,function(e,t,n){return'"\n    + (tokens["'+t+'"](req, res, "'+n+'") || "-") + "'})+'";';return new Function("tokens, req, res",t)}var bytes=require("bytes"),buf=[],defaultBufferDuration=1e3;exports=module.exports=function(e){e="object"==typeof e?e||{}:e?{format:e}:{};var t=e.immediate,n=exports[e.format]||e.format||exports.default;"function"!=typeof n&&(n=compile(n));var r=e.stream||process.stdout,i=e.buffer;if(i){var o=r,s="number"==typeof i?i:defaultBufferDuration;setInterval(function(){buf.length&&(o.write(buf.join("")),buf.length=0)},s),r={write:function(e){buf.push(e)}}}return function(e,i,o){if(e._startTime=new Date,t){var s=n(exports,e,i);if(null==s)return;r.write(s+"\n")}else{var a=i.end;i.end=function(t,o){i.end=a,i.end(t,o);var s=n(exports,e,i);null!=s&&r.write(s+"\n")}}o()}},exports.token=function(e,t){return exports[e]=t,this},exports.format=function(e,t){return exports[e]=t,this},exports.format("default",':remote-addr - - [:date] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent"'),exports.format("short",":remote-addr - :method :url HTTP/:http-version :status :res[content-length] - :response-time ms"),exports.format("tiny",":method :url :status :res[content-length] - :response-time ms"),exports.format("dev",function(e,t,n){var r=n.statusCode,i=parseInt(n.getHeader("Content-Length"),10),o=32;return r>=500?o=31:r>=400?o=33:r>=300&&(o=36),i=isNaN(i)?"":i=" - "+bytes(i),"[90m"+t.method+" "+t.originalUrl+" ["+o+"m"+n.statusCode+" [90m"+(new Date-t._startTime)+"ms"+i+"[0m"}),exports.token("url",function(e){return e.originalUrl||e.url}),exports.token("method",function(e){return e.method}),exports.token("response-time",function(e){return new Date-e._startTime}),exports.token("date",function(){return(new Date).toUTCString()}),exports.token("status",function(e,t){return t.statusCode}),exports.token("referrer",function(e){return e.headers.referer||e.headers.referrer}),exports.token("remote-addr",function(e){return e.socket&&(e.socket.remoteAddress||e.socket.socket&&e.socket.socket.remoteAddress)}),exports.token("http-version",function(e){return e.httpVersionMajor+"."+e.httpVersionMinor}),exports.token("user-agent",function(e){return e.headers["user-agent"]}),exports.token("req",function(e,t,n){return e.headers[n.toLowerCase()]}),exports.token("res",function(e,t,n){return(t._headers||{})[n.toLowerCase()]});