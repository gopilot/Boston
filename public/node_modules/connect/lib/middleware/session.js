function session(e){var e=e||{},t=e.key||"connect.sid",n=e.store||new MemoryStore,r=e.cookie||{},i=e.proxy,o=!0;return"production"==env&&n instanceof MemoryStore&&console.warn(warning),n.generate=function(e){e.sessionID=utils.uid(24),e.session=new Session(e),e.session.cookie=new Cookie(r)},n.on("disconnect",function(){o=!1}),n.on("connect",function(){o=!0}),function(s,a,u){function c(){n.generate(s)}if(s.session)return u();if(!o)return debug("store is disconnected"),u();if(0!=s.originalUrl.indexOf(r.path||"/"))return u();var l=e.secret||s.secret;if(!l)throw new Error("`secret` option required for sessions");{var f,d,p=parse(s);p.pathname}s.sessionStore=n;var h=s.cookies[t],m=s.signedCookies[t];!m&&h&&(m=utils.parseSignedCookie(h,l)),a.on("header",function(){if(s.session){var e=s.session.cookie,n=(s.headers["x-forwarded-proto"]||"").toLowerCase(),r=s.connection.encrypted||i&&"https"==n,o=e.secure&&r,u=m!=s.sessionID;if(e.secure&&!o)return debug("not secured");if(null==e.expires){if(!u)return debug("already set browser-session cookie")}else if(f==hash(s.session)&&d==s.session.id)return debug("unmodified session");var c="s:"+signature.sign(s.sessionID,l);c=e.serialize(t,c),debug("set-cookie %s",c),a.setHeader("Set-Cookie",c)}});var g=a.end;if(a.end=function(e,t){return a.end=g,s.session?(debug("saving"),s.session.resetMaxAge(),s.session.save(function(){debug("saved"),a.end(e,t)}),void 0):a.end(e,t)},s.sessionID=m,!s.sessionID)return debug("no SID sent, generating session"),c(),u(),void 0;var y=utils.pause(s);debug("fetching %s",s.sessionID),n.get(s.sessionID,function(e,t){var r=u;u=function(e){r(e),y.resume()},e?(debug("error"),"ENOENT"==e.code?(c(),u()):u(e)):t?(debug("session found"),n.createSession(s,t),d=s.sessionID,f=hash(t),u()):(debug("no session found"),c(),u())})}}function hash(e){return crc16(JSON.stringify(e,function(e,t){return"cookie"!=e?t:void 0}))}var Session=require("./session/session"),debug=require("debug")("connect:session"),MemoryStore=require("./session/memory"),signature=require("cookie-signature"),Cookie=require("./session/cookie"),Store=require("./session/store"),utils=require("./../utils"),parse=utils.parseUrl,crc16=require("crc").crc16,env=process.env.NODE_ENV;exports=module.exports=session,exports.Store=Store,exports.Cookie=Cookie,exports.Session=Session,exports.MemoryStore=MemoryStore;var warning="Warning: connection.session() MemoryStore is not\ndesigned for a production environment, as it will leak\nmemory, and will not scale past a single process.";