var zlib=require("zlib");exports.methods={gzip:zlib.createGzip,deflate:zlib.createDeflate},exports.filter=function(e,t){return/json|text|javascript/.test(t.getHeader("Content-Type"))},module.exports=function(e){var e=e||{},t=Object.keys(exports.methods),n=e.filter||exports.filter;return function(r,i,o){var a,s,u=r.headers["accept-encoding"],l=i.write,c=i.end;i.setHeader("Vary","Accept-Encoding"),i.write=function(e,t){return this.headerSent||this._implicitHeader(),a?a.write(new Buffer(e,t)):l.call(i,e,t)},i.end=function(e,t){return e&&this.write(e,t),a?a.end():c.call(i)},i.on("header",function(){var o=i.getHeader("Content-Encoding")||"identity";if("identity"==o&&n(r,i)&&u&&"HEAD"!=r.method){if("*"==u.trim()&&(s="gzip"),!s)for(var f=0,p=t.length;p>f;++f)if(~u.indexOf(t[f])){s=t[f];break}s&&(a=exports.methods[s](e),i.setHeader("Content-Encoding",s),i.removeHeader("Content-Length"),a.on("data",function(e){l.call(i,e)}),a.on("end",function(){c.call(i)}),a.on("drain",function(){i.emit("drain")}))}}),o()}};