function htmlPath(e){var t=[];return e.split("/").map(function(e){return t.push(e),'<a href="'+t.join("/")+'">'+e+"</a>"}).join(" / ")}function html(e,t,n){return'<ul id="files">'+e.map(function(e){var r="",i=[];return n&&".."!=e&&(r=icons[extname(e)]||icons.default,r='<img src="data:image/png;base64,'+load(r)+'" />',i.push("icon")),'<li><a href="'+join(t,e)+'" class="'+i.join(" ")+'" title="'+e+'">'+r+e+"</a></li>"}).join("\n")+"</ul>"}function load(e){return cache[e]?cache[e]:cache[e]=fs.readFileSync(__dirname+"/../public/icons/"+e,"base64")}function removeHidden(e){return e.filter(function(e){return"."!=e[0]})}var fs=require("fs"),parse=require("url").parse,utils=require("../utils"),path=require("path"),normalize=path.normalize,extname=path.extname,join=path.join,cache={};exports=module.exports=function(e,t){if(t=t||{},!e)throw new Error("directory() root path required");var n=t.hidden,r=t.icons,i=t.filter,e=normalize(e);return function(t,o,s){if("GET"!=t.method&&"HEAD"!=t.method)return s();var a=t.headers.accept||"text/plain",u=parse(t.url),l=decodeURIComponent(u.pathname),c=normalize(join(e,l)),f=parse(t.originalUrl),p=decodeURIComponent(f.pathname),d=c!=e&&c!=e+"/";return~c.indexOf("\x00")?s(utils.error(400)):0!=c.indexOf(e)?s(utils.error(403)):(fs.stat(c,function(e,u){return e?"ENOENT"==e.code?s():s(e):u.isDirectory()?(fs.readdir(c,function(e,u){if(e)return s(e);n||(u=removeHidden(u)),i&&(u=u.filter(i)),u.sort();for(var l in exports)if(~a.indexOf(l)||~a.indexOf("*/*"))return exports[l](t,o,u,s,p,d,r),void 0;s(utils.error(406))}),void 0):s()}),void 0)}},exports.html=function(e,t,n,r,i,o,s){fs.readFile(__dirname+"/../public/directory.html","utf8",function(e,a){return e?r(e):(fs.readFile(__dirname+"/../public/style.css","utf8",function(e,u){return e?r(e):(o&&n.unshift(".."),a=a.replace("{style}",u).replace("{files}",html(n,i,s)).replace("{directory}",i).replace("{linked-path}",htmlPath(i)),t.setHeader("Content-Type","text/html"),t.setHeader("Content-Length",a.length),t.end(a),void 0)}),void 0)})},exports.json=function(e,t,n){n=JSON.stringify(n),t.setHeader("Content-Type","application/json"),t.setHeader("Content-Length",n.length),t.end(n)},exports.plain=function(e,t,n){n=n.join("\n")+"\n",t.setHeader("Content-Type","text/plain"),t.setHeader("Content-Length",n.length),t.end(n)};var icons={".js":"page_white_code_red.png",".c":"page_white_c.png",".h":"page_white_h.png",".cc":"page_white_cplusplus.png",".php":"page_white_php.png",".rb":"page_white_ruby.png",".cpp":"page_white_cplusplus.png",".swf":"page_white_flash.png",".pdf":"page_white_acrobat.png","default":"page_white.png"};